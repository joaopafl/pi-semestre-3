@model IEnumerable<Pi_Odonto.Models.Atendimento>

@{
    ViewData["Title"] = "Histórico de Atendimentos";
    var criancasList = ViewBag.Criancas as List<dynamic> ?? new List<dynamic>();
    var dentistasList = ViewBag.Dentistas as List<dynamic> ?? new List<dynamic>();
}

<style>
    .page-header {
        background: linear-gradient(135deg, #805ad5, #9f7aea);
        color: white;
        padding: 25px 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        margin-bottom: 25px;
    }

    .atendimento-row {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 12px;
        border-left: 3px solid #805ad5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        transition: all 0.2s ease;
    }

        .atendimento-row:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateX(3px);
        }

    .info-item {
        margin-bottom: 5px;
    }

    .info-label {
        font-size: 0.75rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .info-value {
        font-size: 0.95rem;
        color: #2d3748;
        font-weight: 500;
    }

    .stat-mini {
        background: #f7fafc;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

        .stat-mini h4 {
            margin: 0;
            font-size: 1.5rem;
            color: #2d3748;
        }

        .stat-mini small {
            color: #718096;
            font-size: 0.8rem;
        }

    .search-input {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.2s;
    }

        .search-input:focus {
            border-color: #805ad5;
            box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
        }

    .btn-search {
        border-radius: 8px;
        padding: 10px 25px;
    }

    .obs-text {
        background: #fef5e7;
        border-left: 3px solid #f39c12;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 0.9rem;
        color: #7c6a4d;
        margin-top: 10px;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1"><i class="fas fa-history"></i> Histórico de Atendimentos</h2>
                <p class="mb-0 opacity-90">Consulte todos os atendimentos realizados</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/Dentista/Dashboard" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Estatísticas - Só mostra após pesquisa -->
    @if (ViewBag.PesquisaRealizada == true && Model != null && Model.Any())
    {
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-mini">
                    <h4 class="text-primary">@Model.Count()</h4>
                    <small>Total de Atendimentos</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-mini">
                    <h4 class="text-success">@Model.Select(a => a.IdCrianca).Distinct().Count()</h4>
                    <small>Crianças Atendidas</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-mini">
                    <h4 class="text-info">@Model.Select(a => a.IdDentista).Distinct().Count()</h4>
                    <small>Dentistas</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-mini">
                    <h4 class="text-warning">@Model.Sum(a => a.DuracaoAtendimento)</h4>
                    <small>Min. Totais</small>
                </div>
            </div>
        </div>
    }

    <!-- Busca -->
    <div class="search-card">
        <form method="get" asp-action="Historico">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label info-label">
                        <i class="fas fa-child"></i> Nome da Criança
                    </label>
                    <input type="text"
                           class="form-control search-input"
                           name="nomeCrianca"
                           value="@ViewBag.NomeCrianca"
                           placeholder="Digite o nome..."
                           list="criancasList">
                    <datalist id="criancasList">
                        @if (criancasList != null)
                        {
                            @foreach (var crianca in criancasList)
                            {
                                <option value="@crianca.Nome"></option>
                            }
                        }
                    </datalist>
                </div>

                <div class="col-md-2">
                    <label class="form-label info-label">
                        <i class="fas fa-id-card"></i> CPF da Criança
                    </label>
                    <input type="text"
                           class="form-control search-input"
                           name="cpfCrianca"
                           value="@ViewBag.CpfCrianca"
                           placeholder="000.000.000-00"
                           maxlength="14">
                </div>

                <div class="col-md-3">
                    <label class="form-label info-label">
                        <i class="fas fa-user-md"></i> Nome do Dentista
                    </label>
                    <input type="text"
                           class="form-control search-input"
                           name="nomeDentista"
                           value="@ViewBag.NomeDentista"
                           placeholder="Digite o nome..."
                           list="dentistasList">
                    <datalist id="dentistasList">
                        @if (dentistasList != null)
                        {
                            @foreach (var dentista in dentistasList)
                            {
                                <option value="@dentista.Nome"></option>
                            }
                        }
                    </datalist>
                </div>

                <div class="col-md-2">
                    <label class="form-label info-label">
                        <i class="fas fa-calendar"></i> Data Início
                    </label>
                    <input type="date"
                           class="form-control search-input"
                           name="dataInicio"
                           value="@ViewBag.DataInicio">
                </div>

                <div class="col-md-2">
                    <label class="form-label info-label">
                        <i class="fas fa-calendar"></i> Data Fim
                    </label>
                    <input type="date"
                           class="form-control search-input"
                           name="dataFim"
                           value="@ViewBag.DataFim">
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-search me-2">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <a href="/Atendimento/Historico" class="btn btn-outline-secondary btn-search">
                        <i class="fas fa-eraser"></i> Limpar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Lista de Atendimentos - Só aparece após busca -->
    @if (ViewBag.PesquisaRealizada == true)
    {
        <!-- Resultado -->
        <div class="mb-3">
            <h6 class="text-muted">
                <i class="fas fa-list"></i>
                @(Model?.Count() ?? 0) atendimento(s) encontrado(s)
            </h6>
        </div>

        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                <div class="atendimento-row">
                    <div class="row align-items-center">
                        <!-- Criança -->
                        <div class="col-md-3">
                            <div class="info-item">
                                <div class="info-label">Criança</div>
                                <div class="info-value">
                                    <i class="fas fa-child text-primary"></i>
                                    @(item.Crianca?.Nome ?? "N/A")
                                </div>
                            </div>
                            @if (item.Crianca != null)
                            {
                                <small class="text-muted">
                                    @((DateTime.Now.Year - item.Crianca.DataNascimento.Year)) anos
                                </small>
                            }
                        </div>

                        <!-- Dentista -->
                        <div class="col-md-3">
                            <div class="info-item">
                                <div class="info-label">Dentista</div>
                                <div class="info-value">
                                    <i class="fas fa-user-md text-success"></i>
                                    @(item.Dentista?.Nome ?? "N/A")
                                </div>
                            </div>
                            @if (item.Dentista != null)
                            {
                                <small class="text-muted">CRO @item.Dentista.Cro</small>
                            }
                        </div>

                        <!-- Data/Hora -->
                        <div class="col-md-3">
                            <div class="info-item">
                                <div class="info-label">Data e Hora</div>
                                <div class="info-value">
                                    <i class="fas fa-calendar-alt text-info"></i>
                                    @item.DataAtendimento.ToString("dd/MM/yyyy")
                                    às @item.HorarioAtendimento.ToString(@"hh\:mm")
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-hourglass-half"></i>
                                @item.DuracaoAtendimento min
                            </small>
                        </div>

                        <!-- Ações -->
                        <div class="col-md-3 text-end">
                            <a href="/Atendimento/Details/@item.Id"
                               class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-eye"></i> Detalhes
                            </a>
                            @if (item.Crianca != null)
                            {
                                <a href="/Odontograma/Index?criancaId=@item.IdCrianca"
                                   class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-tooth"></i>
                                </a>
                            }
                        </div>
                    </div>

                    <!-- Observações -->
                    @if (!string.IsNullOrEmpty(item.Observacao))
                    {
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="obs-text">
                                    <strong><i class="fas fa-sticky-note"></i> Obs:</strong>
                                    @item.Observacao
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3 opacity-25"></i>
                <h5 class="text-muted">Nenhum atendimento encontrado</h5>
                <p class="text-muted">Tente ajustar os filtros de busca</p>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        // Máscara de CPF
        const cpfInput = document.querySelector('input[name="cpfCrianca"]');
        if (cpfInput) {
            cpfInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                }
            });
        }

        // Destacar atendimentos do mês atual
        document.addEventListener('DOMContentLoaded', function() {
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();

            document.querySelectorAll('.atendimento-row').forEach(function(row) {
                const dataText = row.querySelector('.info-value');
                if (dataText) {
                    const match = dataText.textContent.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                    if (match) {
                        const mes = parseInt(match[2]) - 1;
                        const ano = parseInt(match[3]);

                        if (mes === mesAtual && ano === anoAtual) {
                            row.style.borderLeftColor = '#48bb78';
                            row.style.borderLeftWidth = '4px';
                        }
                    }
                }
            });
        });
    </script>
}
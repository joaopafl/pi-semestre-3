@model Pi_Odonto.Models.Odontograma

@{
    ViewData["Title"] = "Odontograma - " + ViewBag.Crianca.Nome;
    var crianca = ViewBag.Crianca as Pi_Odonto.Models.Crianca;
    var isAdmin = (bool)ViewBag.IsAdmin;
    var dentistas = ViewBag.Dentistas as List<Pi_Odonto.Models.Dentista>;
}

<style>
    :root {
        --cor-primaria: #2c5282; /* Azul Escuro */
        --cor-secundaria: #4a90e2; /* Azul Claro */
        --cor-esperanca: #48bb78; /* Verde */
        --cor-perigo: #ef4444; /* Vermelho */
        --cor-dente-sadio: #ffffff;
        --cor-dente-carie: #ef4444;
        --cor-dente-restauracao: #3b82f6;
        --cor-dente-extracao: #6b7280;
        --cor-dente-canal: #f59e0b;
        --cor-dente-ausente: #1f2937;
    }

    body {
        font-size: 0.9rem;
    }

    .odontograma-container {
        padding: 15px;
        background: #f7fafc;
    }

    .header-odonto {
        background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria));
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-odonto h1 {
        font-size: 1.5rem;
        margin-bottom: 0;
    }

    .header-odonto p {
        font-size: 0.85rem;
        margin-bottom: 0;
    }

    .info-paciente {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .info-paciente h4 {
        font-size: 1rem;
        margin-bottom: 10px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .info-item {
        padding: 8px 10px;
        background: #f7fafc;
        border-radius: 6px;
        border-left: 3px solid var(--cor-secundaria);
    }

    .info-item strong {
        color: var(--cor-primaria);
        display: block;
        margin-bottom: 3px;
        font-size: 0.8rem;
    }

    .info-item span {
        color: #2d3748;
        font-size: 0.9rem;
    }

    /* Arcadas Dentárias */
    .arcada-container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .arcada-title {
        text-align: center;
        color: var(--cor-primaria);
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--cor-secundaria);
    }

    .dentes-row {
        margin-bottom: 15px;
    }

    .dentes-row:last-child {
        margin-bottom: 0;
    }

    .dentes-grid {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .dentes-grid.deciduos {
        max-width: 600px;
        margin: 0 auto;
    }

    .dente {
        width: 50px;
        height: 65px;
        background: var(--cor-dente-sadio);
        border: 2px solid #cbd5e0;
        border-radius: 6px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .dente:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        border-color: var(--cor-secundaria);
    }

    .dente.selecionado {
        border-color: var(--cor-primaria);
        border-width: 3px;
        box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
    }

    .dente-numero {
        font-weight: bold;
        font-size: 0.95rem;
        color: #2d3748;
        margin-bottom: 3px;
    }

    .dente-icon {
        font-size: 1.4rem;
    }

    /* Status dos dentes */
    .dente.carie {
        background: var(--cor-dente-carie);
        border-color: #dc2626;
        color: white;
    }

    .dente.restauracao {
        background: var(--cor-dente-restauracao);
        border-color: #2563eb;
        color: white;
    }

    .dente.extracao {
        background: var(--cor-dente-extracao);
        border-color: #4b5563;
        color: white;
    }

    .dente.canal {
        background: var(--cor-dente-canal);
        border-color: #d97706;
        color: white;
    }

    .dente.ausente {
        background: var(--cor-dente-ausente);
        border-color: #111827;
        color: white;
        opacity: 0.7;
    }

    .dente.higido {
        background: #d1fae5;
        border-color: var(--cor-esperanca);
    }

    .dente-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Legenda */
    .legenda-container {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .legenda-title {
        color: var(--cor-primaria);
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .legenda-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 10px;
    }

    .legenda-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
    }

    .legenda-cor {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 2px solid #cbd5e0;
        flex-shrink: 0;
    }

    /* Painel de tratamentos */
    .tratamentos-panel {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 15px;
    }

    .tratamentos-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }

    .tratamentos-header h4 {
        font-size: 1rem;
        margin-bottom: 0;
    }

    .tratamento-card {
        background: #f7fafc;
        border-left: 3px solid var(--cor-secundaria);
        padding: 10px 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        transition: all 0.3s;
    }

    .tratamento-card:hover {
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transform: translateX(3px);
    }

    .tratamento-tipo {
        font-weight: bold;
        color: var(--cor-primaria);
        font-size: 1rem;
        margin-bottom: 6px;
    }

    .tratamento-info {
        font-size: 0.85rem;
        color: #4a5568;
        margin-bottom: 4px;
    }

    .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-top: 6px;
    }

    .status-planejado {
        background: #fef3c7;
        color: #92400e;
    }

    .status-em-andamento {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-concluido, .status-concluído {
        background: #d1fae5;
        color: #065f46;
    }

    /* Botões */
    .btn-odonto {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .btn-odonto:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .btn-adicionar {
        background: linear-gradient(135deg, var(--cor-esperanca), #38a169);
        color: white;
    }

    .btn-editar {
        background: #f59e0b;
        color: white;
        padding: 5px 10px;
        font-size: 0.8rem;
    }

    .btn-excluir {
        background: #ef4444;
        color: white;
        padding: 5px 10px;
        font-size: 0.8rem;
    }

    /* Observações */
    .observacoes-container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 15px;
    }

    .observacoes-container h4 {
        font-size: 1rem;
        margin-bottom: 10px;
    }

    .observacoes-container textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
        font-size: 0.9rem;
    }

    .observacoes-container textarea:focus {
        border-color: var(--cor-secundaria);
        outline: none;
    }

    /* Estado vazio */
    .empty-state {
        text-align: center;
        padding: 30px;
        color: #718096;
    }

    .empty-state i {
        font-size: 2.5rem;
        opacity: 0.3;
        margin-bottom: 10px;
    }

    /* Responsivo */
    media (max-width: 768px) {
        .dente {
            width: 45px;
            height: 60px;
        }

        .dente-icon {
            font-size: 1.2rem;
        }

        .dentes-grid {
            gap: 8px;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .header-odonto h1 {
            font-size: 1.3rem;
        }
    }

    /* Loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--cor-secundaria);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Ajustes de botões do header */
    .header-odonto .btn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    /* Modal Styling Improvements */
    .modal-content {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .modal-header-custom {
        background: var(--cor-primaria); /* Usa a cor primária para o cabeçalho */
        color: white;
        border-bottom: 1px solid var(--cor-secundaria);
        padding: 15px 20px;
    }
    
    .modal-header-success {
        background: var(--cor-esperanca);
        color: white;
        border-bottom: 1px solid #38a169;
    }
    
    .modal-header-error {
        background: var(--cor-perigo);
        color: white;
        border-bottom: 1px solid #dc2626;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 15px 20px;
    }
    
    .btn-salvar-modal {
        background: var(--cor-secundaria);
        color: white;
    }
    
    .btn-salvar-modal:hover {
        background: var(--cor-primaria);
        color: white;
    }

    .btn-cancelar-modal {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-cancelar-modal:hover {
        background: #cbd5e0;
    }

    /* Assegura que os botões do modal sigam a base .btn-odonto style */
    .modal-footer .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
    }

    /* Botão OK do modal de alerta */
    .btn-ok-modal {
        background: var(--cor-primaria);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .btn-ok-modal:hover {
        background: var(--cor-secundaria);
    }
</style>

<div class="odontograma-container">
    <div class="header-odonto">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-tooth"></i> Odontograma
                </h1>
                <p class="mb-0 opacity-90">Registro completo da saúde bucal</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/Odontograma/Index" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <a href="/Odontograma/Imprimir/@Model.Id" class="btn btn-light btn-sm" target="_blank">
                    <i class="fas fa-print"></i> Imprimir
                </a>
            </div>
        </div>
    </div>

    <div class="info-paciente">
        <h4 class="text-primary">
            <i class="fas fa-user-circle"></i> Informações do Paciente
        </h4>
        <div class="info-grid">
            <div class="info-item">
                <strong><i class="fas fa-user"></i> Nome</strong>
                <span>@crianca.Nome</span>
            </div>
            <div class="info-item">
                <strong><i class="fas fa-birthday-cake"></i> Idade</strong>
                <span>@(DateTime.Now.Year - crianca.DataNascimento.Year) anos</span>
            </div>
            <div class="info-item">
                <strong><i class="fas fa-calendar-alt"></i> Nascimento</strong>
                <span>@crianca.DataNascimento.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="info-item">
                <strong><i class="fas fa-user-tie"></i> Responsável</strong>
                <span>@(crianca.Responsavel?.Nome ?? "Não informado")</span>
            </div>
            @if (crianca.Responsavel != null && !string.IsNullOrEmpty(crianca.Responsavel.Telefone))
            {
                <div class="info-item">
                    <strong><i class="fas fa-phone"></i> Telefone</strong>
                    <span>@crianca.Responsavel.Telefone</span>
                </div>
            }
            @if (crianca.Responsavel != null && !string.IsNullOrEmpty(crianca.Responsavel.Email))
            {
                <div class="info-item">
                    <strong><i class="fas fa-envelope"></i> E-mail</strong>
                    <span>@crianca.Responsavel.Email</span>
                </div>
            }
        </div>
    </div>

    <div class="legenda-container">
        <div class="legenda-title">
            <i class="fas fa-palette"></i> Legenda de Status
        </div>
        <div class="legenda-grid">
            <div class="legenda-item">
                <div class="legenda-cor" style="background: #d1fae5; border-color: var(--cor-esperanca);"></div>
                <span>Hígido</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor" style="background: var(--cor-dente-carie);"></div>
                <span>Cárie</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor" style="background: var(--cor-dente-restauracao);"></div>
                <span>Restauração</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor" style="background: var(--cor-dente-canal);"></div>
                <span>Canal</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor" style="background: var(--cor-dente-extracao);"></div>
                <span>Extração</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor" style="background: var(--cor-dente-ausente);"></div>
                <span>Ausente</span>
            </div>
        </div>
    </div>

    <div class="arcada-container">
        <div class="arcada-title">
            <i class="fas fa-angle-up"></i> ARCADA SUPERIOR
        </div>
        
        <div class="dentes-row">
            <div class="dentes-grid" id="arcadaSuperiorPermanente">
                @for (int i = 18; i >= 11; i--)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
                @for (int i = 21; i <= 28; i++)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
            </div>
        </div>

        <div class="dentes-row">
            <div class="dentes-grid deciduos" id="arcadaSuperiorDeciduos">
                @for (int i = 55; i >= 51; i--)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
                @for (int i = 61; i <= 65; i++)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="arcada-container">
        <div class="arcada-title">
            <i class="fas fa-angle-down"></i> ARCADA INFERIOR
        </div>

        <div class="dentes-row">
            <div class="dentes-grid deciduos" id="arcadaInferiorDeciduos">
                @for (int i = 85; i >= 81; i--)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
                @for (int i = 71; i <= 75; i++)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
            </div>
        </div>
        
        <div class="dentes-row">
            <div class="dentes-grid" id="arcadaInferiorPermanente">
                @for (int i = 48; i >= 41; i--)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
                @for (int i = 31; i <= 38; i++)
                {
                    <div class="dente" data-numero="@i" onclick="selecionarDente(@i)">
                        <span class="dente-numero">@i</span>
                        <i class="fas fa-tooth dente-icon"></i>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="tratamentos-panel" id="tratamentosPanel" style="display: none;">
        <div class="tratamentos-header">
            <h4 class="mb-0">
                <i class="fas fa-notes-medical"></i> Tratamentos do Dente <span id="denteNumeroSelecionado"></span>
            </h4>
            @if (isAdmin)
            {
                <button type="button" class="btn-odonto btn-adicionar" onclick="abrirModalAdicionarTratamento()">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            }
        </div>

        <div id="listaTratamentos"></div>
    </div>

    <div class="observacoes-container">
        <h4 class="text-primary">
            <i class="fas fa-clipboard"></i> Observações Gerais
        </h4>
        @if (isAdmin)
        {
            <textarea id="observacoesGerais" placeholder="Digite observações gerais sobre o odontograma...">@Model.ObservacoesGerais</textarea>
            <button type="button" class="btn-odonto btn-adicionar mt-2" onclick="salvarObservacoes()">
                <i class="fas fa-save"></i> Salvar Observações
            </button>
        }
        else
        {
            <p class="mb-0">@(string.IsNullOrEmpty(Model.ObservacoesGerais) ? "Sem observações registradas." : Model.ObservacoesGerais)</p>
        }
    </div>
</div>

@if (isAdmin)
{
    <div class="modal fade" id="modalTratamento" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="modalTratamentoTitle">
                        <i class="fas fa-tooth"></i> Adicionar Tratamento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formTratamento">
                        <input type="hidden" id="tratamentoId" />
                        <input type="hidden" id="odontogramaId" value="@Model.Id" />
                        <input type="hidden" id="denteSelecionado" />

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Tipo de Tratamento *</label>
                                <select id="tipoTratamento" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    <option value="Hígido">Hígido (Sadio)</option>
                                    <option value="Cárie">Cárie</option>
                                    <option value="Restauração">Restauração</option>
                                    <option value="Canal">Tratamento de Canal</option>
                                    <option value="Extração">Extração</option>
                                    <option value="Ausente">Ausente</option>
                                    <option value="Prótese">Prótese</option>
                                    <option value="Coroa">Coroa</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Face do Dente</label>
                                <select id="faceDente" class="form-control">
                                    <option value="">Não especificado</option>
                                    <option value="Oclusal">Oclusal</option>
                                    <option value="Vestibular">Vestibular</option>
                                    <option value="Lingual">Lingual</option>
                                    <option value="Mesial">Mesial</option>
                                    <option value="Distal">Distal</option>
                                    <option value="Múltiplas Faces">Múltiplas Faces</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Status *</label>
                                <select id="statusTratamento" class="form-control" required>
                                    <option value="Planejado">Planejado</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Concluído">Concluído</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data do Tratamento</label>
                                <input type="date" id="dataTratamento" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Dentista Responsável</label>
                            <select id="dentistaTratamento" class="form-control">
                                <option value="">Não especificado</option>
                                @foreach (var dentista in dentistas)
                                {
                                    <option value="@dentista.Id">@dentista.Nome</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Observação</label>
                            <textarea id="observacaoTratamento" class="form-control" rows="3" 
                                      placeholder="Observações adicionais sobre o tratamento..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancelar-modal" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-salvar-modal" onclick="salvarTratamento()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div id="alertModalHeader" class="modal-header">
                <h5 class="modal-title" id="alertModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalMessage">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ok-modal" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmExclusaoModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header modal-header-error">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmação Necessária
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este tratamento? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-cancelar-modal" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn-odonto btn-excluir" id="confirmExclusaoBtn">
                    <i class="fas fa-trash"></i> Sim, Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

@section Scripts {
    <script>
        let denteSelecionadoAtual = null;
        let tratamentos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tratamentos.Select(t => new {
            id = t.Id,
            numeroDente = t.NumeroDente,
            tipoTratamento = t.TipoTratamento,
            face = t.Face,
            status = t.Status,
            observacao = t.Observacao,
            dataTratamento = t.DataTratamento?.ToString("yyyy-MM-dd"),
            idDentista = t.IdDentista,
            dentistaNome = t.Dentista?.Nome ?? "Não especificado"
        })));

        const isAdmin = @(isAdmin.ToString().ToLower());

        document.addEventListener('DOMContentLoaded', function() {
            atualizarVisualizacaoDentes();
        });

        // Função para exibir o modal de alerta personalizado
        function showAlertModal(titulo, mensagem, isSuccess = false) {
            const modalHeader = document.getElementById('alertModalHeader');
            
            modalHeader.classList.remove('modal-header-success', 'modal-header-error');
            if (isSuccess) {
                modalHeader.classList.add('modal-header-success');
            } else {
                modalHeader.classList.add('modal-header-error');
            }

            document.getElementById('alertModalTitle').innerHTML = titulo;
            document.getElementById('alertModalMessage').textContent = mensagem;

            new bootstrap.Modal(document.getElementById('alertModal')).show();
        }

        // NOVO: Função para exibir o modal de confirmação personalizado
        function showConfirmModal(callback) {
            const modal = new bootstrap.Modal(document.getElementById('confirmExclusaoModal'));
            const confirmBtn = document.getElementById('confirmExclusaoBtn');
            
            // Remove qualquer listener anterior para evitar execuções duplas
            confirmBtn.onclick = null; 

            // Adiciona o novo listener que executa o callback e fecha o modal
            confirmBtn.onclick = function() {
                modal.hide();
                callback();
            };

            modal.show();
        }

        function selecionarDente(numeroDente) {
            document.querySelectorAll('.dente').forEach(d => d.classList.remove('selecionado'));
            
            const denteElement = document.querySelector(`.dente[data-numero="${numeroDente}"]`);
            if (denteElement) {
                denteElement.classList.add('selecionado');
            }

            denteSelecionadoAtual = numeroDente;
            document.getElementById('denteNumeroSelecionado').textContent = numeroDente;

            carregarTratamentosDente(numeroDente);
            document.getElementById('tratamentosPanel').style.display = 'block';
            document.getElementById('tratamentosPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function carregarTratamentosDente(numeroDente) {
            showLoading();
            
            try {
                const response = await fetch(`/Odontograma/ObterTratamentosDente?idOdontograma=@Model.Id&numeroDente=${numeroDente}`);
                const data = await response.json();

                if (data.success) {
                    exibirTratamentos(data.tratamentos);
                } else {
                    showAlertModal('Erro de Carregamento', 'Erro ao carregar tratamentos: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlertModal('Erro de Comunicação', 'Erro ao carregar tratamentos.');
            } finally {
                hideLoading();
            }
        }

        function exibirTratamentos(tratamentosDoDente) {
            const container = document.getElementById('listaTratamentos');
            
            if (!tratamentosDoDente || tratamentosDoDente.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tooth"></i>
                        <p>Nenhum tratamento registrado para este dente.</p>
                        ${isAdmin ? '<small>Clique em "Adicionar" para registrar.</small>' : ''}
                    </div>
                `;
                return;
            }

            let html = '';
            tratamentosDoDente.forEach(t => {
                const statusClass = t.status.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
                html += `
                    <div class="tratamento-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="tratamento-tipo">${t.tipoTratamento}</div>
                                ${t.face ? `<div class="tratamento-info"><strong>Face:</strong> ${t.face}</div>` : ''}
                                <div class="tratamento-info"><strong>Data:</strong> ${t.dataTratamento || 'Não especificada'}</div>
                                <div class="tratamento-info"><strong>Dentista:</strong> ${t.dentistaNome}</div>
                                ${t.observacao ? `<div class="tratamento-info"><strong>Obs:</strong> ${t.observacao}</div>` : ''}
                                <span class="status-badge status-${statusClass}">${t.status}</span>
                            </div>
                            ${isAdmin ? `
                                <div class="d-flex gap-1">
                                    <button class="btn-odonto btn-editar" onclick="editarTratamento(${t.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-odonto btn-excluir" onclick="excluirTratamento(${t.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function atualizarVisualizacaoDentes() {
            const tratamentosPorDente = {};
            // Agrupa todos os tratamentos por número de dente
            tratamentos.forEach(t => {
                if (!tratamentosPorDente[t.numeroDente]) {
                    tratamentosPorDente[t.numeroDente] = [];
                }
                tratamentosPorDente[t.numeroDente].push(t);
            });

            document.querySelectorAll('.dente').forEach(denteEl => {
                const numero = parseInt(denteEl.dataset.numero);
                const tratamentosDoDente = tratamentosPorDente[numero] || [];

                denteEl.classList.remove('carie', 'restauracao', 'canal', 'extracao', 'ausente', 'higido');

                const badgeExistente = denteEl.querySelector('.dente-badge');
                if (badgeExistente) badgeExistente.remove();

                if (tratamentosDoDente.length > 0) {
                    // Ordena os tratamentos pela data (o mais recente fica na posição [0])
                    tratamentosDoDente.sort((a, b) => {
                        const dateA = a.dataTratamento ? new Date(a.dataTratamento) : new Date(0); 
                        const dateB = b.dataTratamento ? new Date(b.dataTratamento) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    const ultimoTratamento = tratamentosDoDente[0];
                    const tipo = ultimoTratamento.tipoTratamento.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); 

                    // Aplica a cor/status do último tratamento (o mais recente)
                    if (tipo.includes('carie')) {
                        denteEl.classList.add('carie');
                    } else if (tipo.includes('restauracao')) {
                        denteEl.classList.add('restauracao');
                    } else if (tipo.includes('canal')) {
                        denteEl.classList.add('canal');
                    } else if (tipo.includes('extracao')) {
                        denteEl.classList.add('extracao');
                    } else if (tipo.includes('ausente')) {
                        denteEl.classList.add('ausente');
                    } else if (tipo.includes('higido')) {
                        denteEl.classList.add('higido');
                    }

                    // Adiciona o badge com a contagem total de tratamentos
                    const badge = document.createElement('span');
                    badge.className = 'dente-badge';
                    badge.textContent = tratamentosDoDente.length;
                    denteEl.appendChild(badge);
                }
            });
        }

        function abrirModalAdicionarTratamento() {
            if (!denteSelecionadoAtual) {
                showAlertModal('Atenção', 'Selecione um dente primeiro.');
                return;
            }

            document.getElementById('modalTratamentoTitle').innerHTML = '<i class="fas fa-tooth"></i> Adicionar Tratamento - Dente ' + denteSelecionadoAtual;
            document.getElementById('tratamentoId').value = '';
            document.getElementById('denteSelecionado').value = denteSelecionadoAtual;
            document.getElementById('formTratamento').reset();
            document.getElementById('dataTratamento').value = new Date().toISOString().split('T')[0];

            new bootstrap.Modal(document.getElementById('modalTratamento')).show();
        }

        async function editarTratamento(id) {
            showLoading();

            try {
                const tratamento = tratamentos.find(t => t.id === id);
                if (!tratamento) {
                    showAlertModal('Erro', 'Tratamento não encontrado.');
                    return;
                }

                document.getElementById('modalTratamentoTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Tratamento - Dente ' + tratamento.numeroDente;
                document.getElementById('tratamentoId').value = tratamento.id;
                document.getElementById('denteSelecionado').value = tratamento.numeroDente;
                document.getElementById('tipoTratamento').value = tratamento.tipoTratamento;
                document.getElementById('faceDente').value = tratamento.face || '';
                document.getElementById('statusTratamento').value = tratamento.status;
                document.getElementById('dataTratamento').value = tratamento.dataTratamento || '';
                document.getElementById('dentistaTratamento').value = tratamento.idDentista || '';
                document.getElementById('observacaoTratamento').value = tratamento.observacao || '';

                new bootstrap.Modal(document.getElementById('modalTratamento')).show();
            } catch (error) {
                console.error('Erro:', error);
                showAlertModal('Erro de Carregamento', 'Erro ao carregar dados do tratamento.');
            } finally {
                hideLoading();
            }
        }

        async function salvarTratamento() {
            const tratamentoId = document.getElementById('tratamentoId').value;
            const isEdicao = tratamentoId !== '';

            const dados = {
                id: tratamentoId ? parseInt(tratamentoId) : 0,
                idOdontograma: parseInt(document.getElementById('odontogramaId').value),
                numeroDente: parseInt(document.getElementById('denteSelecionado').value),
                tipoTratamento: document.getElementById('tipoTratamento').value,
                face: document.getElementById('faceDente').value,
                status: document.getElementById('statusTratamento').value,
                dataTratamento: document.getElementById('dataTratamento').value || null,
                idDentista: document.getElementById('dentistaTratamento').value ? parseInt(document.getElementById('dentistaTratamento').value) : null,
                observacao: document.getElementById('observacaoTratamento').value
            };

            if (!dados.tipoTratamento || !dados.status) {
                showAlertModal('Atenção', 'Preencha os campos obrigatórios.');
                return;
            }

            showLoading();

            try {
                const url = isEdicao ? `/Odontograma/EditarTratamento?id=${tratamentoId}` : '/Odontograma/AdicionarTratamento';
                
                const formData = new FormData();
                Object.keys(dados).forEach(key => {
                    if (dados[key] !== null && dados[key] !== '') {
                        formData.append(key, dados[key]);
                    }
                });

                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlertModal('Sucesso', data.message, true);
                    bootstrap.Modal.getInstance(document.getElementById('modalTratamento')).hide();
                    
                    setTimeout(() => location.reload(), 1500); 
                } else {
                    showAlertModal('Erro', 'Erro: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlertModal('Erro de Comunicação', 'Erro ao salvar tratamento.');
            } finally {
                hideLoading();
            }
        }

        async function excluirTratamento(id) {
            // Usa o modal de confirmação personalizado
            showConfirmModal(async () => {
                showLoading();

                try {
                    const formData = new FormData();
                    formData.append('id', id);
                    
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (token) {
                        formData.append('__RequestVerificationToken', token);
                    }

                    const response = await fetch('/Odontograma/ExcluirTratamento', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlertModal('Sucesso', data.message, true);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showAlertModal('Erro', 'Erro: ' + data.message);
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showAlertModal('Erro de Comunicação', 'Erro ao excluir tratamento.');
                } finally {
                    hideLoading();
                }
            });
        }

        async function salvarObservacoes() {
            const observacoes = document.getElementById('observacoesGerais').value;
            
            showLoading();

            try {
                const formData = new FormData();
                formData.append('id', @Model.Id);
                formData.append('observacoes', observacoes);
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch('/Odontograma/AtualizarObservacoes', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlertModal('Sucesso', data.message, true);
                } else {
                    showAlertModal('Erro', 'Erro: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlertModal('Erro de Comunicação', 'Erro ao salvar observações.');
            } finally {
                hideLoading();
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    </script>
}
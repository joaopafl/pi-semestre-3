@model Pi_Odonto.ViewModels.AppointmentViewModel
@using System.Security.Claims

@{
    ViewBag.Title = "Agendamento de Consulta Odontológica";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // O comentário que aparecia foi removido.
}

<link rel="stylesheet" href="~/css/Agendamento.css" asp-append-version="true" />
<div class="card-wp">
    
    @if(TempData["ErrorMessage"] != null)
    {
        <div class="alert-banner error-banner">
            <i class="bi bi-x-octagon-fill"></i>
            <p>@TempData["ErrorMessage"]</p>
        </div>
    }

    <h1 class="page-title">Agendamento de Consulta Odontológica <i class="bi bi-calendar-heart-fill"></i></h1>

    <form method="post" asp-action="Confirmar" asp-controller="Agendamento" id="agendamentoForm">
        <h3>Selecione a criança a ser atendida:</h3>
        <div class="select-row">
            <select name="SelectedChildId" id="childSelect" class="styled-select" onchange="enableDates()">
                <option value="">Selecione uma criança</option>
                @foreach(Crianca c in Model.Children)
                {
                    <option value="@c.Id" data-name="@c.Nome">@c.Nome</option>
                }
            </select>
        </div>
        
        <input type="hidden" name="SelectedDentistaId" id="dentistInput" /> 

        <div id="datesSection" style="display:none;">
            <h3>Selecione o dia do atendimento:</h3>
            <div class="dates-row">
                @foreach(var d in Model.AvailableDates)
                {
                    <button type="button" class="date-btn" onclick="selectDateAndLoadTimes('@d.ToString("yyyy-MM-dd")', this)">@d.ToString("dd/MM")</button>
                }
            </div>
        </div>

        <div id="timesSection" style="display:none;">
            <h3>Selecione o horário do atendimento:</h3>
            <div class="times-grid">
                </div>
        </div>
        
        <input type="hidden" name="SelectedDateString" id="dateInput" />
        <input type="hidden" name="SelectedTime" id="timeInput" />
        <input type="hidden" name="SelectedChildId" id="childInput" /> 

    </form>
    
</div>


<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header" style="background-color: var(--green-main); color: white; border-radius: 12px 12px 0 0;">
                
                <h5 class="modal-title" id="summaryModalLabel">
                    <i class="bi bi-calendar-heart-fill"></i> Resumo do Agendamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="summary-details" style="text-align: left;">
                    <p><span class="sq-icon"></span> <strong>Criança selecionada:</strong> <span id="summaryChildNameModal"></span></p>
                    
                    <p><span class="sq-icon"></span> <strong>Responsável:</strong> @User.Identity.Name</p>
                    
                    <p><span class="sq-icon"></span> <strong>Dentista:</strong> <span id="summaryDentistNameModal"></span></p>
                    
                    <hr>
                    <p style="font-size: 1.2rem;"><span class="sq-icon" style="background-color: var(--blue-main);"></span> <strong>Data:</strong> <span id="summaryDateModal" style="font-weight: bold;"></span></p>
                    <p style="font-size: 1.2rem;"><span class="sq-icon" style="background-color: var(--blue-main);"></span> <strong>Horário:</strong> <span id="summaryTimeModal" style="font-weight: bold;"></span></p>
                </div>
            </div>
            <div class="modal-footer actions" style="justify-content: space-around; border-top: none;">
                <button type="button" class="confirm-btn" onclick="confirmAndSubmit()">Confirmar agendamento</button>
                <button type="button" class="btn-outline" data-bs-dismiss="modal">Revisar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        let selectedDateDisplay = ''; 
        let selectedChildName = '';
        
        const summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));


        function enableDates() {
            const childSelect = document.getElementById('childSelect');
            const datesSection = document.getElementById('datesSection');
            const timesSection = document.getElementById('timesSection');
            
            selectedChildName = childSelect.options[childSelect.selectedIndex]?.dataset.name || '';
            
            document.getElementById('childInput').value = childSelect.value;
            
            if (childSelect.value !== "") {
                datesSection.style.display = 'block';
            } else {
                datesSection.style.display = 'none';
                timesSection.style.display = 'none';
                summaryModal.hide(); 
            }
        }

        async function selectDateAndLoadTimes(selectedDate, button) {
            document.querySelectorAll('.dates-row .date-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            document.getElementById('dateInput').value = selectedDate;
            selectedDateDisplay = button.textContent; 

            const timesGrid = document.querySelector('.times-grid');
            timesGrid.innerHTML = '<h4>Carregando horários...</h4>'; 
            document.getElementById('timesSection').style.display = 'block';
            summaryModal.hide();
            
            const url = `/Agendamento/GetAvailableTimes?dateString=${selectedDate}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                timesGrid.innerHTML = ''; 

                if (data.success && data.times.length > 0) {
                    
                    data.times.forEach(slot => {
                        const timeButton = document.createElement('button');
                        timeButton.type = 'button'; 
                        timeButton.className = 'time-btn';
                        
                        // Exibe apenas o horário (sem o nome do dentista)
                        timeButton.textContent = slot.time; 
                        
                        timeButton.dataset.slotData = JSON.stringify(slot);
                        
                        timeButton.onclick = () => showSummaryModal(slot, timeButton);
                        timesGrid.appendChild(timeButton);
                    });
                } else {
                    timesGrid.innerHTML = '<p style="color: red; font-weight: bold; margin-top: 10px;">Nenhum dentista com horário disponível para este dia.</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar horários:', error);
                // Mensagem amigável para erro de carregamento AJAX
                timesGrid.innerHTML = `
                    <p class="error-agendamento-text">
                        <i class="bi bi-exclamation-triangle-fill"></i> Falha ao carregar horários. Tente selecionar outra data.
                    </p>
                `;
            }
        }
        
        function showSummaryModal(slot, button) {
            document.querySelectorAll('.times-grid .time-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            
            // PREENCHE OS INPUTS OCULTOS COM O HORÁRIO E O ID DO DENTISTA
            document.getElementById('timeInput').value = slot.time;
            document.getElementById('dentistInput').value = slot.dentistaId;
            
            // Preenche os detalhes no modal
            document.getElementById('summaryChildNameModal').textContent = selectedChildName;
            document.getElementById('summaryDateModal').textContent = selectedDateDisplay; 
            document.getElementById('summaryTimeModal').textContent = slot.time;
            document.getElementById('summaryDentistNameModal').textContent = slot.dentistaName;
            
            summaryModal.show();
        }

        function confirmAndSubmit() {
            summaryModal.hide();
            document.getElementById('agendamentoForm').submit();
        }

        enableDates();
    </script>
}
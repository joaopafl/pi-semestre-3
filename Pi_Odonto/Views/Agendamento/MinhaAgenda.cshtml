@model List<Pi_Odonto.Models.Agendamento>

@using System.Security.Claims 
@using Pi_Odonto.Models 
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Minha Agenda";
    Layout = "~/Views/Shared/_Layout.cshtml";

    bool IsActive(DateTime data, TimeSpan hora)
    {
        var dataHoraAgendamento = data.Date.Add(hora);
        return dataHoraAgendamento >= DateTime.Now; 
    }
}

<style>
    :root {
        --cor-primaria: #4A90E2; 
        --cor-secundaria: #66BB6A; 
        --cor-danger: #DC3545; 
        --cor-gradiente-start: #FFD700; 
        --cor-gradiente-end: #FFA07A; 
        --cor-finalizada-start: #F0F0F0; 
        --cor-finalizada-end: #D0D0D0; 
    }

    /* CABEÇALHO */
    .page-title {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1.5rem 0;
    }

    .page-title h2 {
        color: #2c3e50;
        font-weight: 600;
        font-size: 2rem;
        margin: 0;
    }

    .page-title i {
        font-size: 2.5rem;
        margin-right: 0.5rem;
        vertical-align: middle;
    }

    /* BARRA DE AÇÕES */
    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }

    .status-legend {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .status-legend span:first-child {
        font-weight: 600;
        color: #2c3e50;
        margin-right: 0.5rem;
    }

    .status-legend .badge {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        border-radius: 20px;
    }

    .btn-novo-agendamento {
        background-color: var(--cor-primaria);
        border: none;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-novo-agendamento:hover {
        background-color: #3a7bc8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }

    /* LAYOUT PRINCIPAL */
    .main-content {
        display: flex;
        gap: 2rem;
    }

    .agendamentos-section {
        flex: 1;
    }

    .filters-sidebar {
        width: 280px;
        flex-shrink: 0;
    }

    /* CARDS DE AGENDAMENTO */
    .agendamentos-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }

    media (max-width: 1400px) {
        .agendamentos-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    media (max-width: 992px) {
        .agendamentos-grid {
            grid-template-columns: 1fr;
        }
        
        .main-content {
            flex-direction: column;
        }
        
        .filters-sidebar {
            width: 100%;
        }
    }

    .agendamento-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: white;
    }

    .agendamento-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .agendamento-card.agendamento-finalizado {
        opacity: 0.65;
    }

    .agendamento-card.agendamento-finalizado:hover {
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: default;
    }

    .card-header-custom {
        padding: 0.9rem 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .agendamento-ativo .card-header-custom {
        background: linear-gradient(135deg, var(--cor-gradiente-start) 0%, var(--cor-gradiente-end) 100%);
    }

    .agendamento-finalizado .card-header-custom {
        background: linear-gradient(135deg, var(--cor-finalizada-start) 0%, var(--cor-finalizada-end) 100%);
    }

    .card-header-custom .crianca-nome {
        font-weight: 600;
        font-size: 1.05rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-header-custom .status-badge-small {
        padding: 0.3rem 0.7rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .card-header-custom .status-badge-small.bg-success {
        color: white !important;
    }

    .card-header-custom .status-badge-small.bg-secondary {
        color: #2c3e50 !important;
    }

    .agendamento-body {
        padding: 1.2rem;
        background-color: white;
    }

    .info-row {
        margin-bottom: 1rem;
    }

    .info-row:last-child {
        margin-bottom: 0;
    }

    .info-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
        display: block;
    }

    .info-value {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 600;
    }

    /* SIDEBAR DE FILTROS */
    .filters-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        position: sticky;
        top: 20px;
    }

    .filters-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .filter-group {
        margin-bottom: 1.5rem;
    }

    .filter-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
        margin-bottom: 0.6rem;
    }

    .filter-input {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--cor-primaria);
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }

    .dentist-list {
        max-height: 180px;
        overflow-y: auto;
        padding: 0.8rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        background-color: #f8f9fa;
    }

    .dentist-list .form-check {
        margin-bottom: 0.5rem;
    }

    .dentist-list .form-check:last-child {
        margin-bottom: 0;
    }

    .dentist-list .form-check-label {
        font-size: 0.85rem;
        color: #495057;
        cursor: pointer;
    }

    .calendar-container {
        text-align: center;
    }

    .inline-calendar {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.5rem;
        background-color: white;
        margin-bottom: 0.75rem;
    }

    /* Estilos para o datepicker inline */
    #inlineCalendar .ui-datepicker {
        width: 100%;
        font-size: 0.85rem;
    }

    #inlineCalendar .ui-datepicker table {
        font-size: 0.85rem;
    }

    .btn-clear-date {
        width: 100%;
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .calendar-info {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }

    .btn-apply-filters {
        width: 100%;
        background-color: var(--cor-primaria);
        border: none;
        color: white;
        padding: 0.8rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
    }

    .btn-apply-filters:hover {
        background-color: #3a7bc8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }

    /* MODAL */
    .overlay-actions {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .btn-action-edit, .btn-action-cancel {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.8rem;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .btn-action-edit {
        background-color: var(--cor-secundaria);
    }

    .btn-action-edit:hover {
        background-color: #57a75a;
        transform: scale(1.1);
    }

    .btn-action-cancel {
        background-color: var(--cor-danger);
    }

    .btn-action-cancel:hover {
        background-color: #c82333;
        transform: scale(1.1);
    }

    /* DATEPICKER */
    .ui-datepicker {
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    .ui-state-event a {
        background-color: #66BB6A !important;
        color: white !important;
        font-weight: bold !important;
        border-radius: 50% !important;
    }

    /* MENSAGENS */
    .alert {
        border-radius: 8px;
        border: none;
        margin-bottom: 1.5rem;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background-color: #f8f9fa;
        border-radius: 12px;
    }

    .empty-state i {
        font-size: 4rem;
        color: #adb5bd;
        margin-bottom: 1.5rem;
    }

    .empty-state h4 {
        color: #495057;
        margin-bottom: 0.75rem;
    }

    .empty-state p {
        color: #6c757d;
        margin-bottom: 1.5rem;
    }
</style>

<div class="container-fluid px-4">
    
    @* CABEÇALHO CENTRALIZADO *@
    <div class="page-title">
        <h2><i class="fas fa-calendar-alt"></i> Minha Agenda</h2>
    </div>

    @* MENSAGENS *@
    @if (TempData["SuccessMessageTitle"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong><i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessageTitle"]</strong> @TempData["SuccessMessageBody"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="fas fa-exclamation-circle me-2"></i>Erro!</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* BARRA DE AÇÕES: LEGENDA + BOTÃO NOVO *@
    <div class="actions-bar">
        <div class="status-legend">
            <span>Legenda:</span>
            <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i> Ativo
            </span>
            <span class="badge bg-secondary">
                <i class="fas fa-history me-1"></i> Finalizado
            </span>
        </div>
        
        <a asp-controller="Agendamento" asp-action="Index" class="btn btn-novo-agendamento">
            <i class="fas fa-plus me-2"></i> Novo Agendamento
        </a>
    </div>

    @* LAYOUT PRINCIPAL: CARDS + FILTROS *@
    <div class="main-content">
        
        @* SEÇÃO DE AGENDAMENTOS *@
        <div class="agendamentos-section">
            @if (Model != null && Model.Any())
            {
                <div class="agendamentos-grid">
                    @foreach (var agendamento in Model)
                    {
                        var isAgendamentoAtivo = IsActive(agendamento.DataAgendamento, agendamento.HoraAgendamento);
                        var statusClass = isAgendamentoAtivo ? "agendamento-ativo" : "agendamento-finalizado";
                        
                        <div class="agendamento-card @statusClass" 
                             onclick="@(isAgendamentoAtivo ? $"showEditModal({agendamento.Id}, '{agendamento.Crianca?.Nome}', '{agendamento.DataAgendamento:dd/MM/yyyy}', '{agendamento.HoraAgendamento:hh\\:mm}')" : "")">
                            
                            <div class="card-header-custom">
                                <span class="crianca-nome">
                                    <i class="fas fa-child"></i>
                                    @(agendamento.Crianca?.Nome ?? "Criança Removida")
                                </span>
                                <span class="status-badge-small @(isAgendamentoAtivo ? "bg-success" : "bg-secondary")">
                                    @(isAgendamentoAtivo ? "Ativo" : "Finalizado")
                                </span>
                            </div>

                            <div class="agendamento-body">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar me-1"></i> Data</span>
                                    <div class="info-value">@agendamento.DataAgendamento.ToString("dd/MM/yyyy")</div>
                                </div>
                                
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-clock me-1"></i> Horário</span>
                                    <div class="info-value">@agendamento.HoraAgendamento.ToString(@"hh\:mm")</div>
                                </div>
                                
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-user-md me-1"></i> Dentista</span>
                                    <div class="info-value">@(agendamento.Dentista?.Nome ?? "Indefinido")</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h4>Nenhum Agendamento Encontrado</h4>
                    <p>Você ainda não possui consultas agendadas ou os filtros não retornaram resultados.</p>
                    <a asp-controller="Agendamento" asp-action="Index" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Criar Novo Agendamento
                    </a>
                </div>
            }
        </div>

        @* SIDEBAR DE FILTROS *@
        <div class="filters-sidebar">
            <div class="filters-card">
                <div class="filters-title">
                    <i class="fas fa-filter"></i>
                    Filtros
                </div>
                
                <form method="get" asp-action="MinhaAgenda" id="filterForm">
                    
                    @* FILTRO: NOME DA CRIANÇA *@
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-child"></i>
                            Nome da Criança
                        </label>
                        <input type="text" 
                               class="filter-input" 
                               id="searchName" 
                               name="searchName" 
                               placeholder="Digite o nome..."
                               value="@ViewData["CurrentNameFilter"]" />
                    </div>

                    @* FILTRO: DENTISTA *@
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-user-md"></i>
                            Dentista
                        </label>
                        <div class="dentist-list">
                            @{
                                var selectedDentists = ViewData["SelectedDentists"] as List<int> ?? new List<int>();
                            }
                            @if (ViewBag.Dentistas != null)
                            {
                                @foreach (var dentista in (List<Dentista>)ViewBag.Dentistas)
                                {
                                    var isChecked = selectedDentists.Contains(dentista.Id);
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               name="dentists" 
                                               value="@dentista.Id" 
                                               id="dentist_@dentista.Id" 
                                               @(isChecked ? "checked" : "")>
                                        <label class="form-check-label" for="dentist_@dentista.Id">
                                            @dentista.Nome
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @* FILTRO: DATA *@
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-calendar-day"></i>
                            Data Específica
                        </label>
                        
                        <div class="calendar-container">
                            <button type="button" class="btn btn-outline-secondary btn-clear-date" id="clearDateFilter">
                                <i class="fas fa-times me-1"></i> Limpar Filtro de Data
                            </button>
                            
                            <div id="inlineCalendar" class="inline-calendar"></div>
                            
                            <input type="hidden" 
                                   id="selectedDate" 
                                   name="selectedDate" 
                                   value="@ViewData["CurrentDateFilter"]" />
                            
                            <div class="calendar-info">
                                <i class="fas fa-info-circle"></i>
                                Datas com agendamentos aparecem destacadas
                            </div>
                        </div>
                    </div>

                    @* BOTÃO APLICAR *@
                    <button type="submit" class="btn btn-apply-filters">
                        <i class="fas fa-search me-2"></i> Aplicar Filtros
                    </button>
                </form>
            </div>
        </div>

    </div>
</div>

@* MODAL DE AÇÃO *@
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-body text-center" style="padding: 2.5rem;">
                <h5 class="mb-3">
                    <i class="fas fa-calendar-check me-2"></i> 
                    Gerenciar Agendamento
                </h5>
                <p class="text-muted mb-1" style="font-size: 1.1rem;">
                    <strong id="criancaNomeModal"></strong>
                </p>
                <p class="text-muted mb-4">
                    <i class="fas fa-calendar-day me-1"></i> 
                    <span id="dataHoraModal"></span>
                </p>
                
                <div class="overlay-actions">
                    <button id="btnEdit" class="btn btn-action-edit" title="Editar Agendamento">
                        <i class="fas fa-edit"></i>
                    </button>
                    
                    <button id="btnCancel" class="btn btn-action-cancel" title="Cancelar Agendamento">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@* MODAL DE CONFIRMAÇÃO DE CANCELAMENTO *@
<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: 2px solid var(--cor-danger);">
            <div class="modal-header bg-danger text-white" style="border-radius: 14px 14px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i> Confirmar Cancelamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" style="padding: 2rem;">
                <i class="fas fa-exclamation-circle text-danger mb-3" style="font-size: 3rem;"></i>
                <p style="font-size: 1.1rem; line-height: 1.6;">
                    Você está prestes a cancelar o agendamento de<br>
                    <strong id="cancelCriancaNome" style="color: var(--cor-danger);"></strong><br>
                    no dia <strong id="cancelDataHora"></strong>
                </p>
                <p class="text-danger fw-bold mt-3">
                    ⚠️ Esta ação não pode ser desfeita!
                </p>
                
                <form id="cancelForm" asp-controller="Agendamento" asp-action="Cancelar" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="cancelAgendamentoId" name="id" value="" />
                    <button type="submit" class="btn btn-danger mt-3 w-100" style="padding: 0.75rem;">
                        <i class="fas fa-trash-alt me-2"></i> Sim, Cancelar Permanentemente
                    </button>
                </form>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i> Manter Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <!-- jQuery (se ainda não estiver carregado) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jQuery UI JS -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <script>
        let currentAgendamentoId = 0;
        let actionModal;

        const eventDates = @Html.Raw(JsonConvert.SerializeObject(ViewBag.DatasAgendadas ?? new List<string>()));
        
        function hasAppointment(date) {
            const dateString = (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
            return eventDates.includes(dateString);
        }

        $(document).ready(function() {
            actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
            
            // Botão Editar
            document.getElementById('btnEdit').addEventListener('click', function() {
                if (currentAgendamentoId > 0) {
                    window.location.href = `/Agendamento/Editar/${currentAgendamentoId}`;
                }
            });

            // Botão Cancelar
            document.getElementById('btnCancel').addEventListener('click', function() {
                if (currentAgendamentoId > 0) {
                    actionModal.hide();
                    
                    const crianca = document.getElementById('criancaNomeModal').innerText;
                    const dataHora = document.getElementById('dataHoraModal').innerText;

                    document.getElementById('cancelCriancaNome').innerText = crianca;
                    document.getElementById('cancelDataHora').innerText = dataHora;
                    document.getElementById('cancelAgendamentoId').value = currentAgendamentoId;

                    const confirmCancelModal = new bootstrap.Modal(document.getElementById('confirmCancelModal'));
                    confirmCancelModal.show();
                }
            });

            // Inicializar Datepicker INLINE
            $("#inlineCalendar").datepicker({
                dateFormat: 'dd/mm/yy',
                beforeShowDay: function(date) {
                    if (hasAppointment(date)) {
                        return [true, 'ui-state-event', 'Agendamento nesta data'];
                    }
                    return [true, ''];
                },
                onSelect: function(dateText) {
                    $('#selectedDate').val(dateText);
                    $('#filterForm').submit();
                }
            });

            // Se já houver uma data selecionada, destacar no calendário
            const currentDate = '@ViewData["CurrentDateFilter"]';
            if (currentDate) {
                const parts = currentDate.split('/');
                if (parts.length === 3) {
                    const date = new Date(parts[2], parts[1] - 1, parts[0]);
                    $("#inlineCalendar").datepicker('setDate', date);
                }
            }
            
            // Limpar filtro de data
            $('#clearDateFilter').on('click', function() {
                $('#selectedDate').val('');
                $("#inlineCalendar").datepicker('setDate', null);
                $('#filterForm').submit();
            });
        });

        function showEditModal(id, criancaNome, data, hora) {
            currentAgendamentoId = id;
            document.getElementById('criancaNomeModal').innerText = criancaNome;
            document.getElementById('dataHoraModal').innerText = `${data} às ${hora}`;
            actionModal.show();
        }
    </script>
}
@model Pi_Odonto.ViewModels.AppointmentViewModel
@using Pi_Odonto.Models

@{
    ViewBag.Title = "Agendamento de Consulta Odontológica";
    var actionName = ViewBag.Action ?? "Confirmar";
    var isEditing = ViewBag.IsEditing ?? false;
}

<link rel="stylesheet" href="~/css/Agendamento.css" asp-append-version="true" />

<style>
    /* Estilos do Autocomplete */
    .autocomplete-wrapper {
        position: relative;
        width: 100%;
    }
    
    .autocomplete-input {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .autocomplete-input:focus {
        outline: none;
        border-color: var(--green-main);
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--green-main);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none;
    }
    
    .autocomplete-list.show {
        display: block;
    }
    
    .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #eee;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover,
    .autocomplete-item.active {
        background-color: #f0f9f0;
    }
    
    .autocomplete-no-results {
        padding: 12px;
        color: #999;
        text-align: center;
    }
</style>

<div class="card-wp">
    
    @if(TempData["ErrorMessage"] != null)
    {
        <div class="alert-banner error-banner">
            <i class="bi bi-x-octagon-fill"></i>
            <p>@TempData["ErrorMessage"]</p>
        </div>
    }
    
    <h1 class="page-title">
        @(isEditing ? "Editar Agendamento" : "Agendamento de Consulta Odontológica") 
        <i class="bi bi-calendar-heart-fill"></i>
    </h1>

    <form method="post" asp-action="@actionName" asp-controller="Agendamento" id="agendamentoForm">
        
        <input type="hidden" id="childInput" asp-for="SelectedChildId" />
        <input type="hidden" id="dateInput" asp-for="SelectedDateString" />
        <input type="hidden" id="timeInput" asp-for="SelectedTime" />
        <input type="hidden" id="dentistInput" asp-for="SelectedDentistaId" />
        
        @if (isEditing)
        {
            <input type="hidden" asp-for="AgendamentoId" />
        }
        
        <h3>Digite o nome da criança a ser atendida:</h3>
        <div class="select-row">
            <div class="autocomplete-wrapper">
                <input 
                    type="text" 
                    id="childSearchInput" 
                    class="autocomplete-input"
                    placeholder="Digite o nome da criança..."
                    autocomplete="off"
                    oninput="filterChildren(this.value)"
                    onfocus="showAutocomplete()"
                />
                <div id="childAutocompleteList" class="autocomplete-list">
                    @foreach(Crianca c in Model.Children)
                    {
                        var isSelected = isEditing && Model.SelectedChildId == c.Id;
                        <div 
                            class="autocomplete-item @(isSelected ? "preselected" : "")" 
                            data-id="@c.Id" 
                            data-name="@c.Nome"
                            onclick="selectChild(@c.Id, '@c.Nome')">
                            @c.Nome
                        </div>
                    }
                </div>
            </div>
        </div>
        

        <div id="datesSection" style="display:none;">
            <h3>Selecione o dia do atendimento:</h3>
            <div class="dates-row">
                @foreach(var d in Model.AvailableDates)
                {
                    var dateStr = d.ToString("yyyy-MM-dd");
                    var isSelected = isEditing && Model.SelectedDateString == dateStr;
                    
                    <button 
                        type="button" 
                        class="date-btn @(isSelected ? "selected" : "")" 
                        data-date="@dateStr"
                        onclick="selectDateAndLoadTimes('@dateStr', this)">
                        @d.ToString("dd/MM")
                    </button>
                }
            </div>
        </div>

        <div id="timesSection" style="display:none;">
            <h3>Selecione o horário do atendimento:</h3>
            <div id="timesGrid" class="times-grid">
            </div>
        </div>
        
    </form>
</div>


<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header" style="background-color: var(--green-main); color: white; border-radius: 12px 12px 0 0;">
                <h5 class="modal-title" id="summaryModalLabel">
                    <i class="bi bi-calendar-heart-fill"></i> 
                    @(isEditing ? "Confirmar Edição" : "Resumo do Agendamento")
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="summary-details" style="text-align: left;">
                    <p><span class="sq-icon"></span> <strong>Criança selecionada:</strong> <span id="summaryChildNameModal"></span></p>
                    
                    <p><span class="sq-icon"></span> <strong>Responsável:</strong> @User.Identity.Name</p>
                    
                    <p>
                        <span class="sq-icon"></span> 
                        <strong>Dentista:</strong> 
                        <div id="summaryDentistSelectDiv" class="d-inline-block">
                            <span id="summaryDentistNameModal"></span>
                        </div>
                    </p>
                    
                    <hr>
                    <p style="font-size: 1.2rem;"><span class="sq-icon" style="background-color: var(--blue-main);"></span> <strong>Data:</strong> <span id="summaryDateModal" style="font-weight: bold;"></span></p>
                    <p style="font-size: 1.2rem;"><span class="sq-icon" style="background-color: var(--blue-main);"></span> <strong>Horário:</strong> <span id="summaryTimeModal" style="font-weight: bold;"></span></p>
                </div>
            </div>
            <div class="modal-footer actions" style="justify-content: space-around; border-top: none;">
                <button type="button" class="confirm-btn" onclick="confirmAndSubmit()">
                    @(isEditing ? "Atualizar Agendamento" : "Confirmar Agendamento")
                </button>
                <button type="button" class="btn-outline" data-bs-dismiss="modal">Revisar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        let selectedDateDisplay = ''; 
        let selectedChildName = '';
        let availableSlotsByTime = {}; 
        let allChildren = [];
        
        const summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));

        // =======================================================
        // FUNÇÕES DE AUTOCOMPLETE
        // =======================================================
        
        // Inicializa a lista de crianças ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            const items = document.querySelectorAll('.autocomplete-item');
            items.forEach(item => {
                allChildren.push({
                    id: item.dataset.id,
                    name: item.dataset.name
                });
            });
            
            // Se está em modo de edição, pré-seleciona a criança
            const preselected = document.querySelector('.autocomplete-item.preselected');
            if (preselected) {
                const childId = preselected.dataset.id;
                const childName = preselected.dataset.name;
                selectChild(childId, childName);
            }
            
            // Handler para fechar autocomplete ao clicar fora
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    hideAutocomplete();
                }
            });
        });
        
        function filterChildren(searchTerm) {
            const list = document.getElementById('childAutocompleteList');
            const items = list.querySelectorAll('.autocomplete-item');
            const normalizedSearch = searchTerm.toLowerCase().trim();
            
            let hasResults = false;
            
            items.forEach(item => {
                const childName = item.dataset.name.toLowerCase();
                if (childName.includes(normalizedSearch)) {
                    item.style.display = 'block';
                    hasResults = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostra/esconde a lista
            if (searchTerm.length > 0) {
                list.classList.add('show');
                
                // Se não houver resultados, mostra mensagem
                if (!hasResults) {
                    let noResults = list.querySelector('.autocomplete-no-results');
                    if (!noResults) {
                        noResults = document.createElement('div');
                        noResults.className = 'autocomplete-no-results';
                        noResults.textContent = 'Nenhuma criança encontrada';
                        list.appendChild(noResults);
                    }
                    noResults.style.display = 'block';
                } else {
                    const noResults = list.querySelector('.autocomplete-no-results');
                    if (noResults) noResults.style.display = 'none';
                }
            } else {
                list.classList.remove('show');
            }
        }
        
        function showAutocomplete() {
            const input = document.getElementById('childSearchInput');
            if (input.value.length > 0) {
                document.getElementById('childAutocompleteList').classList.add('show');
            }
        }
        
        function hideAutocomplete() {
            document.getElementById('childAutocompleteList').classList.remove('show');
        }
        
        function selectChild(childId, childName) {
            selectedChildName = childName;
            
            // Atualiza o input visual
            document.getElementById('childSearchInput').value = childName;
            
            // Atualiza o input oculto
            document.getElementById('childInput').value = childId;
            
            // Esconde a lista
            hideAutocomplete();
            
            // Habilita a seção de datas
            enableDates();
        }

        // =======================================================
        // FUNÇÕES DE EXIBIÇÃO E SELEÇÃO
        // =======================================================

        function enableDates() {
            const childInput = document.getElementById('childInput');
            const datesSection = document.getElementById('datesSection');
            const timesSection = document.getElementById('timesSection');
            
            if (childInput.value !== "") {
                datesSection.style.display = 'block';
            } else {
                datesSection.style.display = 'none';
                timesSection.style.display = 'none';
                summaryModal.hide(); 
            }
        }

        async function selectDateAndLoadTimes(selectedDate, button) {
            document.querySelectorAll('.dates-row .date-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            document.getElementById('dateInput').value = selectedDate;
            selectedDateDisplay = button.textContent; 

            const timesGrid = document.getElementById('timesGrid');
            timesGrid.innerHTML = '<h4>Carregando horários...</h4>'; 
            document.getElementById('timesSection').style.display = 'block';
            summaryModal.hide();
            
            const url = `/Agendamento/GetAvailableTimes?dateString=${selectedDate}`;
            
            const isEditing = @(ViewBag.IsEditing ? "true" : "false");
            const selectedTimeForEdit = isEditing && '@Model.SelectedTime' ? '@Model.SelectedTime' : null;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                timesGrid.innerHTML = ''; 
                availableSlotsByTime = {};

                if (data.success && data.times.length > 0) {
                    
                    data.times.forEach(slot => {
                        const timeKey = slot.time;
                        if (!availableSlotsByTime[timeKey]) {
                            availableSlotsByTime[timeKey] = [];
                        }
                        availableSlotsByTime[timeKey].push(slot);
                    });

                    Object.keys(availableSlotsByTime).forEach(time => {
                        const slots = availableSlotsByTime[time];
                        const timeButton = document.createElement('button');
                        timeButton.type = 'button'; 
                        timeButton.className = 'time-btn';
                        timeButton.textContent = time; 
                        
                        timeButton.onclick = () => showSummaryModal(slots, timeButton);
                        
                        if (isEditing && time === selectedTimeForEdit) {
                            timeButton.classList.add('selected');
                            showSummaryModal(slots, timeButton, true); 
                        }
                        
                        timesGrid.appendChild(timeButton);
                    });
                    
                } else {
                    timesGrid.innerHTML = '<p class="error-agendamento-text">Nenhum horário disponível para este dia.</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar horários:', error);
                timesGrid.innerHTML = `
                    <p class="error-agendamento-text">
                        <i class="bi bi-exclamation-triangle-fill"></i> Falha ao carregar horários. Tente selecionar outra data.
                    </p>
                `;
            }
        }
        
        function showSummaryModal(slots, button, isInitialLoad = false) {
            const isEditing = @(ViewBag.IsEditing ? "true" : "false");
            const currentDentistIdForEdit = isEditing && @Model.SelectedDentistaId ? @Model.SelectedDentistaId : null;
            
            if (!isInitialLoad) {
                document.querySelectorAll('.times-grid .time-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
            }

            const dentistSelectDiv = document.getElementById('summaryDentistSelectDiv');
            dentistSelectDiv.innerHTML = '';

            let selectedSlot = slots.find(s => s.dentistaId === currentDentistIdForEdit) || slots[0];

            if (slots.length > 1) {
                let selectHtml = '<select id="dentistSelection" class="form-select" onchange="updateDentistInputs(this.value)">';
                
                slots.forEach(slot => {
                    const selected = (isEditing && slot.dentistaId === currentDentistIdForEdit) || (!isEditing && slots.indexOf(slot) === 0);
                    selectHtml += `<option value="${slot.dentistaId}" data-name="${slot.dentistaName}" ${selected ? 'selected' : ''}>${slot.dentistaName}</option>`;
                });
                selectHtml += '</select>';
                dentistSelectDiv.innerHTML = selectHtml;
                
            } else {
                dentistSelectDiv.innerHTML = `<span id="summaryDentistNameModal">${selectedSlot.dentistaName}</span>`;
            }
            
            document.getElementById('timeInput').value = slots[0].time; 
            document.getElementById('dentistInput').value = selectedSlot.dentistaId; 
            
            document.getElementById('summaryChildNameModal').textContent = selectedChildName;
            document.getElementById('summaryDateModal').textContent = selectedDateDisplay; 
            document.getElementById('summaryTimeModal').textContent = slots[0].time;
            
            if (slots.length === 1) {
                 const nameSpan = document.getElementById('summaryDentistNameModal');
                 if(nameSpan) nameSpan.textContent = selectedSlot.dentistaName;
            }

            if (!isInitialLoad) {
                summaryModal.show();
            } else if (isEditing && slots.length > 1) {
                updateDentistInputs(selectedSlot.dentistaId);
            }
        }
        
        function updateDentistInputs(selectedDentistId) {
            const timeKey = document.getElementById('timeInput').value;
            const slotsForTime = availableSlotsByTime[timeKey];
            
            if (slotsForTime) {
                const selectedSlot = slotsForTime.find(s => s.dentistaId == selectedDentistId);
                if (selectedSlot) {
                    document.getElementById('dentistInput').value = selectedSlot.dentistaId;
                    
                    const nameSpan = document.getElementById('summaryDentistNameModal');
                    if(nameSpan) nameSpan.textContent = selectedSlot.dentistaName;
                }
            }
        }

        function confirmAndSubmit() {
            if (document.getElementById('childInput').value === "" || document.getElementById('dateInput').value === "" || document.getElementById('timeInput').value === "" || document.getElementById('dentistInput').value === "") {
                alert("Por favor, complete a seleção de Criança, Data, Horário e Dentista.");
                return;
            }
            summaryModal.hide();
            document.getElementById('agendamentoForm').submit();
        }

        // =======================================================
        // INICIALIZAÇÃO E EDIÇÃO
        // =======================================================
        
        document.addEventListener('DOMContentLoaded', () => {
             const childInput = document.getElementById('childInput');
             const dateInput = document.getElementById('dateInput');
             
             if (childInput.value && dateInput.value) {
                 enableDates();
                 
                 const dateButton = document.querySelector(`.date-btn[data-date="${dateInput.value}"]`);
                 if (dateButton) {
                     setTimeout(() => {
                         dateButton.click(); 
                     }, 10);
                 }
             }
        });
    </script>
}